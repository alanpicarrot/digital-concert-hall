# 除錯對話記錄 - 購票流程和圖片載入問題

日期: 2025-03-30

## 問題描述

用戶反映在購票過程中，即使已經登入，點選「立即購買」時系統仍要求重新登入，且在登入後又被導向回登入頁面，形成循環。此外，控制台顯示大量與圖片相關的 HTTP 500 錯誤。

## 診斷過程

初始診斷涉及檢查控制台日誌，發現兩個主要問題：

1. 授權流程中的 401 未授權錯誤
2. 大量圖片載入請求返回 500 錯誤

深入檢查了以下關鍵文件：

- `ConcertDetailPage.jsx`: 音樂會詳情頁面，包含加入購物車和立即購買功能
- `CheckoutPage.jsx`: 結帳頁面，處理購票和支付
- `Login.jsx`: 登入邏輯和重定向處理
- `authService.js`: 處理用戶認證、令牌管理和授權請求

## 發現的問題

1. **授權問題**:
   - `ConcertDetailPage.jsx` 中缺少正確的加入購物車功能實現
   - 登入重定向邏輯未正確處理 URL 查詢參數
   - 某些 API 請求未攜帶授權 token

2. **圖片問題**:
   - 前端使用 `/api/placeholder/...` 路徑請求圖片，但這個路徑返回 500 錯誤

## 實施的修改

### 1. 授權和購票流程修復

- 實現正確的購物車功能，連接到 `cartService`
- 增強登入後的重定向邏輯，能夠正確解析和處理 URL 查詢參數
- 統一使用 `authService.axiosInstance` 發送授權請求
- 在購票流程的每個關鍵步驟檢查用戶登入狀態

### 2. 圖片載入問題修復

- 創建內置的 SVG 佔位圖元件 `SimplePlaceholder`，消除對外部圖片的依賴
- 在音樂會詳情頁面中使用這個元件來顯示封面和圖庫

## 測試結果

通過以下測試案例確認修復效果：

1. **已登入用戶購票流程**: 順利完成
2. **未登入用戶購票流程**: 被導向登入頁面，登入後自動返回並繼續
3. **圖片顯示**: 所有佔位圖正確顯示，不再有 HTTP 500 錯誤

## 學到的教訓

1. **圖片處理**: 在開發階段使用內置元件替代外部資源可以減少不必要的錯誤
2. **認證狀態管理**: 在多頁面應用中保持一致的授權狀態檢查非常重要
3. **重定向處理**: 登入後的重定向邏輯需要能夠處理各種 URL 格式和參數

## 進一步改進建議

1. 考慮實現真實的佔位圖服務，而不是依賴內置 SVG
2. 添加更全面的錯誤處理和用戶通知機制
3. 實現更穩健的授權檢查邏輯，包括令牌刷新機制

## 相關文檔

- [debug-auth-flow-and-image-placeholders.md](./debug-auth-flow-and-image-placeholders.md): 詳細的技術修復記錄
